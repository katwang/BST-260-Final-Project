---
title: "Hosp Level Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#inner-joined data of hosp_data and and hospital demographics data 
#each row is a unique physician, but there can be multiple physicians working in the same hospital
#nrow = 269663
hosp_merged <- readRDS("/Users/jiminyoo/Desktop/BST260-FALL2017/BST-260-Final-Project/Hosp_merged_data.rds")
```

#More Data Manipulation
#Aggregate hosp_merged data at hospital level so that each row is a unique hospital 
```{r}
full_data <- hosp_merged %>% 
  group_by(Hospital.affiliation.LBN.1, City_trimmed) 

#Recompute Gender and EHR-use variables into numerics
full_data$Gender_num <- ifelse(full_data$Gender == "F", 1, 0)
full_data$EHR_num <- ifelse(full_data$Used.electronic.health.records == "Y", 1, 0)

agg_data <- summarise(full_data, num_phys = n_distinct(NPI), female_prop = round(mean(Gender_num),2), avg_grad_year = mean(Graduation.year), n_specialty =n_distinct(Primary.specialty), EHR_use = max(EHR_num), staffed_beds = mean(Staffed_beds), total_discharge = mean(Total_discharges), patient_days = mean(Patient_days), gross_patient_rev = mean(Gross_patient_revenue))

table(agg_data$EHR_use)
# Checking the if the EHR_use variable is accurate
# EHR_y_list <- agg_data[agg_data$EHR_use == 1, ]$Hospital.affiliation.LBN.1
# EHR_y_data <- subset(hosp_merged, Hospital.affiliation.LBN.1 %in% EHR_y_list)
# table(EHR_y_data$Used.electronic.health.records)
# 
# EHR_n_hosp <- agg_data[agg_data$EHR_use == 0, ]
# test = inner_join(hosp_merged, EHR_n_hosp, by=c("Hospital.affiliation.LBN.1" = "Hospital.affiliation.LBN.1", "City_trimmed" = "City_trimmed"))
# table(test$Used.electronic.health.records)

#RECODE Using EHR_use==1 -> Y, 0 -> ""
agg_data$EHR_char <- ifelse(agg_data$EHR_use == 1, "Y", "Blank")
#RECODE Years since medical school graduation
agg_data$yrs_since_grad = 2017 - agg_data$avg_grad_year

#setwd("~Desktop/BST260-FALL2017/BST-260-Final-Project")
#data aggregated on hospital level
#each row is a uniquehospital 
#nrow = 1746
#saveRDS(agg_data, "Hosps_aggregated.rds")
```
 
```{r}
table(agg_data$EHR_char)
#Explore small-sample size hospitals with less than ten physicians
lessTen <- agg_data[which(agg_data$num_phys < 10), ]
table(lessTen$EHR_use_yn)

agg_data[agg_data$gross_patient_rev == 0, ]
```


```{r}
hist(agg_data$staffed_beds, lim=c(0,500))
boxplot(staffed_beds~EHR_use_yn,data=agg_data, 
        xlab="EHR Use", ylab="Staffed_beds", ylim = c(0,1000))
```

```{r}
boxplot(total_discharge~EHR_use_yn,data=agg_data, 
        xlab="EHR Use", ylab="Total discharge")
```

```{r}
boxplot(patient_days~EHR_use_yn,data=agg_data, 
        xlab="EHR Use", ylab="Patient days")
```

```{r}
boxplot(gross_patient_rev~EHR_use_yn,data=agg_data, 
        xlab="EHR Use", ylab="Yearly gross patient revenue")
```

```{r}
boxplot(num_phys~EHR_char ,data=agg_data, 
        xlab="EHR Use", ylab="Number of Practitioners")
boxplot(female_prop~EHR_char ,data=agg_data, 
        xlab="EHR Use", ylab="Proportion of Female")
boxplot(yrs_since_grad~EHR_char ,data=agg_data, 
        xlab="EHR Use", ylab="Years since graduation")
boxplot(n_specialty~EHR_char ,data=agg_data, 
        xlab="EHR Use", ylab="Number of specialties")
```
```{r}
#Check for correlations
X <- c("num_phys", "female_prop", "avg_grad_year", "n_specialty", "staffed_beds", "total_discharge", "patient_days", "gross_patient_rev")
cor(agg_data$num_phys, agg_data$EHR_use)
cor(agg_data$female_prop, agg_data$EHR_use)
cor(agg_data$yrs_since_grad, agg_data$EHR_use)
cor(agg_data$n_specialty, agg_data$EHR_use)
cor(agg_data$staffed_beds, agg_data$EHR_use)
cor(agg_data$total_discharge, agg_data$EHR_use)
cor(agg_data$patient_days, agg_data$EHR_use)
cor(agg_data$gross_patient_rev, agg_data$EHR_use)

# Packages
library(RColorBrewer)
library(car)

# Make the plot
my_colors <- brewer.pal(nlevels(as.factor(agg_data$EHR_char)), "Set1")
scatterplotMatrix(~num_phys+female_prop+yrs_since_grad+staffed_beds+gross_patient_rev|EHR_char, data=agg_data, col=my_colors , smoother.args=list(col="grey") , cex=1.5 , pch=c(15,16))

```