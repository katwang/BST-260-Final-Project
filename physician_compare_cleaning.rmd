---
title: 'BST 260 Final Project: Cleaning Physician Compare National Data File'
author: Eunice Yeh
output: html_document
---

# Purpose
1. explore the data and summarize key variables
2. clean/reduce data: decide which rows and columns to filter out

## 1. Exploratory Analysis
Import data from `.csv` file.
```{r}
dat <- read.csv("Physician_Compare_National_Downloadable_File.csv")
```

Quick look at the data structure.
```{r}
str(dat)
```

Load `tidyverse` package for data wrangling and plotting functions.
```{r}
library(tidyverse)
```

Check frequency of Medicare assignment acceptance.
```{r}
table(dat$Professional.accepts.Medicare.Assignment)
```

Look at the distribution of physician graduation year by physician credentials and by use of EHR.
```{r}
gradyr <- dat %>% filter(!is.na(Graduation.year)) %>% 
  group_by(Credential, Used.electronic.health.records) 

gradyr %>% 
  ggplot(aes(Graduation.year)) +
  geom_histogram(color = "black") +
  facet_grid(.~Used.electronic.health.records) +
  ggtitle("Distribution of Grduation Year by Use of EHR")

gradyr %>% filter(Used.electronic.health.records == 'Y') %>%
  ungroup() %>% 
  mutate(Credential = reorder(Credential, Graduation.year)) %>% 
  ggplot(aes(factor(Credential), Graduation.year)) +
  geom_boxplot() + 
  # scale_y_continuous(trans = "sqrt", breaks = seq(0, 100, 2)^2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.25)) +
  xlab("Credential") +
  ylab("Graduation Year") +
  ggtitle("Dist of Grad Year by Credential among those who used EHR")

gradyr %>%
  ungroup() %>% 
  mutate(Credential = reorder(Credential, Graduation.year)) %>% 
  ggplot(aes(factor(Credential), Graduation.year)) +
  geom_boxplot() + 
  facet_grid(.~Used.electronic.health.records) +
  # scale_y_continuous(trans = "sqrt", breaks = seq(0, 100, 2)^2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.25)) +
  xlab("Credential") +
  ylab("Graduation Year") +
  ggtitle("Dist of Grad Year by Credential")
```

Look at the distribution of physician graduation year by US States separately for those who used EHR and for those who have not indicated using EHR.
```{r}
# for those who used EHR
gradyr %>% ungroup() %>% filter(Used.electronic.health.records == 'Y') %>% 
  mutate(State = reorder(State, Graduation.year)) %>% 
  ggplot(aes(factor(State), Graduation.year)) +
  geom_boxplot() + 
  # facet_grid(.~Used.electronic.health.records) +
  # scale_y_continuous(trans = "sqrt", breaks = seq(0, 100, 2)^2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.25)) +
  xlab("US State") +
  ylab("Graduation Year") +
  ggtitle("Dist of Grad Year by State among those who used EHR")

# for those who did not indicate having used EHR
gradyr %>% ungroup() %>% filter(Used.electronic.health.records != 'Y') %>% 
  mutate(State = reorder(State, Graduation.year)) %>% 
  ggplot(aes(factor(State), Graduation.year)) +
  geom_boxplot() + 
  # facet_grid(.~Used.electronic.health.records) +
  # scale_y_continuous(trans = "sqrt", breaks = seq(0, 100, 2)^2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.25)) +
  xlab("US State") +
  ylab("Graduation Year") +
  ggtitle("Dist of Grad Year by State among those who have not indicated using EHR")
```

Calculate the proportion of EHR use by State.
```{r}
EHR_bystate <- dat %>% 
  group_by(State) %>% 
  summarize(EHR_count = sum(Used.electronic.health.records == 'Y'), total = n(), 
            EHR_prop = EHR_count/total)
EHR_bystate
```

Plot the proportion of EHR use by State.
```{r}
EHR_bystate %>% mutate(State = reorder(State, EHR_prop)) %>% 
  ggplot(aes(factor(State), EHR_prop)) +
  geom_point() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.25)) +
  xlab("State") +
  ylab("Proportion of EHR Used") +
  ggtitle("Proportion of EHR Used by State")
```

Calculate the percentage of EHR use by Primary Specialty and by State. -- consider filterning out n() < 50 or 100?
```{r}
EHR_primspec_bystate <- dat %>% 
  filter(!is.na(Graduation.year)) %>% 
  group_by(State, Primary.specialty) %>% 
  summarize(EHR_count = sum(Used.electronic.health.records == 'Y'), total = n(), EHR_percent = EHR_count/total * 100) %>% 
  mutate(Primary.specialty = reorder(Primary.specialty, EHR_percent))
EHR_primspec_bystate
```

Plot the percentage of EHR use by Primary Specialty and by State.
```{r}
library(RColorBrewer)
EHR_primspec_bystate %>% filter(total > 100) %>% 
  ggplot(aes(Primary.specialty, State,  fill = EHR_percent)) +
  geom_tile(color = "grey50") +
  # scale_x_continuous(expand=c(0,0)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_fill_gradientn(colors = brewer.pal(9, "YlGn")) +  
  theme(panel.grid = element_blank()) +
  ylab("US States") + 
  xlab("Primary Specialty") +
  ggtitle("Percentage of EHR Used by Primary Specialty and States")
```


## 2. Data Cleaning Decisions:

1. filter out states outside of the main 50 except for DC since there is not a lot of information in those states and the other data we want to merge with do not contain information on these states anyway.

```{r}
unique(dat$State)
data("state")
new_dat <- dat[dat$State %in% unique(state.abb) == "TRUE" | dat$State == "DC", ]
unique(new_dat$State)
```

2. keep only rows with `Professional.accepts.Medicare.Assignment = 'Y'` since we are only interested in practioners who have definitely accepted medicare assignments, and we need to merge with other data that only contain those serving Medicare.

```{r}
table(new_dat$Professional.accepts.Medicare.Assignment)
filtered_dat <- new_dat %>% filter(Professional.accepts.Medicare.Assignment == 'Y')
table(filtered_dat$Professional.accepts.Medicare.Assignment)
```

3. key variables are NPI, last and first name, gender, credential, medical school name, grad year, prim specialty, all sec specialties,  organization legal name, num of group practice members, city, state, zip code,  hospital affiliation CCNs and LBNs,  used EHR, reported qual measures.

```{r}
# easier to exclude using -
select_dat <- filtered_dat %>% select(-PAC.ID, -Professional.Enrollment.ID, -Middle.Name, -Suffix, -Group.Practice.PAC.ID, -Line.1.Street.Address, -Line.2.Street.Address, -Marker.of.address.line.2.suppression, -Phone.Number, -Professional.accepts.Medicare.Assignment, -Committed.to.heart.health.through.the.Million.Hearts√Ç..initiative.)
str(select_dat)
```

4. merge in accurate city, state, latitude, longitude information by zip codes using the `zipcode` package.

```{r}
# separate out the first five zip codes from the last four extension
ziptest <- select_dat$Zip.Code[1]
ziptest
substr(as.character(ziptest), 1, 5)
substr(as.character(ziptest), 6, 9)
zip_dat <- select_dat %>% mutate(zip = substr(as.character(Zip.Code), 1, 5), zip.ext = substr(as.character(Zip.Code), 6, 9))

# use R zipcode package and data
library(zipcode)
data("zipcode")
zip_dat <- zip_dat %>% left_join(zipcode,by='zip') 
zip_dat %>% select(NPI, Zip.Code, zip, zip.ext, City, State, city, state, latitude, longitude) %>% head(.,20)
```

Check mismatched city and state between our data and the zipcode data from R.
```{r}
zip_dat %>% mutate(City = as.character(City), city = toupper(as.character(city))) %>% filter(City != city) %>% select(NPI, Zip.Code, City, city, State, state) %>% head(.,50)
zip_dat %>% mutate(State = as.character(State), state = as.character(state)) %>% filter(State != state) %>% select(NPI, Zip.Code, City, city, State, state) %>% head(.,50)
```

5. keep only one record per physician (using NPI, first/last name, graduation year, primary specialty and state just to be extra precise)
```{r}
library(dplyr)
unique_dat <- zip_dat %>% distinct(NPI, Last.Name, First.Name, Graduation.year, Primary.specialty, State, .keep_all = TRUE)
```
Note that the argument `.keep_all = TRUE` keeps all other variables not considered in the combination of variables that determine the uniqueness. If the combination is not distinct, the first row of values is kept, which is fine because we don't really care as much about the other variables. For example, the organization legal name and city may vary across multiple rows for the same physician who owns a private practice and renames or moves the practice around the area but still within the same state.

6. separate into two datasets by hospital affiliation vs. none

```{r}
# those with some kind of hospital affiliation
hosp <- unique_dat %>% filter(Hospital.affiliation.CCN.1 != "" | Hospital.affiliation.CCN.2 != "" | Hospital.affiliation.CCN.3 != "" | Hospital.affiliation.CCN.4 != "" | !is.na(Hospital.affiliation.CCN.5))
saveRDS(hosp, file="hosp.rds")

# those without any hospital affiliation
phys <- unique_dat %>% filter(Hospital.affiliation.CCN.1 == "" & Hospital.affiliation.CCN.2 == "" & Hospital.affiliation.CCN.3 == "" & Hospital.affiliation.CCN.4 == "" & is.na(Hospital.affiliation.CCN.5))
saveRDS(phys, file="phys.rds")
```


